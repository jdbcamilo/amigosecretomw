<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Amigo Secreto</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        button {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        #friend-result {
            font-size: 22px;
            font-weight: bold;
            color: #1d3bb8;
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 10px;
        }
        
        .admin-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .admin-options button {
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .back-button {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }
        
        .info-text {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #ff4b2b;
            margin: 10px 0;
            padding: 10px;
            background-color: #ffe6e6;
            border-radius: 5px;
        }
        
        .success-message {
            color: #2bff42;
            margin: 10px 0;
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 5px;
        }
        
        .firebase-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .connected {
            background-color: #e6ffe6;
            color: #2bff42;
        }
        
        .disconnected {
            background-color: #ffe6e6;
            color: #ff4b2b;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sección de Login -->
        <div id="login-section" class="section active">
            <h1>Amigo Secreto</h1>
            <p class="info-text">Ingresa tu código único para descubrir a tu amigo secreto</p>
            <input type="text" id="code-input" placeholder="Ingresa tu código">
            <button onclick="checkCode()">Descubrir amigo</button>
            <button onclick="showAdminLogin()" class="back-button">Acceso administrador</button>
            
            <div id="firebase-status" class="firebase-status disconnected">
                Firebase: Conectando...
            </div>
        </div>

        <!-- Sección de Resultado -->
        <div id="result-section" class="section">
            <h1>¡Resultado!</h1>
            <div id="friend-result"></div>
            <button onclick="resetApp()">Volver al inicio</button>
        </div>

        <!-- Sección de Login de Administrador -->
        <div id="admin-login-section" class="section">
            <h1>Acceso de Administrador</h1>
            <p class="info-text">Ingresa la clave de administrador</p>
            <input type="password" id="admin-password" placeholder="Clave de administrador">
            <button onclick="checkAdminPassword()">Acceder</button>
            <button onclick="resetApp()" class="back-button">Cancelar</button>
        </div>

        <!-- Sección de Administrador -->
        <div id="admin-section" class="section">
            <h1>Panel de Administración</h1>
            <p class="info-text">Lista de participantes y sus códigos</p>
            
            <div id="firebase-status-admin" class="firebase-status disconnected">
                Firebase: Conectando...
            </div>
            
            <div id="loading-message">Cargando datos...</div>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>
            
            <table style="display: none;">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Código</th>
                        <th>Asignado a</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body">
                    <!-- Los datos se cargarán dinámicamente -->
                </tbody>
            </table>
            
            <div class="admin-options">
                <button onclick="exportCodesExcel()">Exportar códigos a Excel</button>
                <button onclick="exportFullExcel()">Exportar asignaciones a Excel</button>
                <button onclick="clearAssignments()">Eliminar asignaciones</button>
                <button onclick="reloadParticipants()">Recargar participantes</button>
                <button onclick="resetApp()" class="back-button">Volver al inicio</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACIÓN DE FIREBASE (CON TUS DATOS)
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCnDQLKYlThT3yUzh02xYOlOPPs1kd0fRc",
            authDomain: "amigosecreto-babb3.firebaseapp.com",
            projectId: "amigosecreto-babb3",
            storageBucket: "amigosecreto-babb3.firebasestorage.app",
            messagingSenderId: "83114307483",
            appId: "1:83114307483:web:891e5b3a0db3227b5cfb3e",
            measurementId: "G-YQ01R8E013"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore();
        
        // Verificar conexión a Firebase
        db.enablePersistence()
          .then(() => {
              updateFirebaseStatus('connected', 'Firebase: Conectado correctamente');
          })
          .catch((err) => {
              console.error("Error con Firebase Persistence:", err);
              updateFirebaseStatus('disconnected', 'Firebase: Modo sin conexión');
          });
        
        // =============================================
        // DATOS INICIALES
        // =============================================
        const initialParticipants = [
            { name: "Yajaira", gender: "mujer", code: "" },
            { name: "Yesika", gender: "mujer", code: "" },
            { name: "Levis", gender: "mujer", code: "" },
            { name: "Karen", gender: "mujer", code: "" },
            { name: "Valentina", gender: "mujer", code: "" },
            { name: "Yisel", gender: "mujer", code: "" },
            { name: "Piedad", gender: "mujer", code: "" },
            { name: "Leidy", gender: "mujer", code: "" },
            { name: "Liz", gender: "mujer", code: "" },
            { name: "Laura", gender: "mujer", code: "" },
            { name: "Gregoria", gender: "mujer", code: "" },
            { name: "Jorge", gender: "hombre", code: "" },
            { name: "Jose", gender: "hombre", code: "" },
            { name: "Daner", gender: "hombre", code: "" },
            { name: "Victor", gender: "hombre", code: "" },
            { name: "Deimer", gender: "hombre", code: "" },
            { name: "Willian", gender: "hombre", code: "" },
            { name: "Gustavo", gender: "hombre", code: "" },
            { name: "Fabian", gender: "hombre", code: "" },
            { name: "Carlos", gender: "hombre", code: "" },
            { name: "Huber", gender: "hombre", code: "" },
            { name: "Juan David", gender: "hombre", code: "" },
            { name: "Sebastian", gender: "hombre", code: "" },
            { name: "Juan Camilo", gender: "hombre", code: "" },
            { name: "Luis Rodriguez", gender: "hombre", code: "" },
            { name: "Claudia Gonzales", gender: "mujer", code: "" }
        ];

        // Clave de administrador
        const ADMIN_PASSWORD = "MWSOLUTIONDIAZ2025";

        // Variables globales
        let assignments = {};
        let allParticipants = [];

        // =============================================
        // FUNCIONES DE FIREBASE
        // =============================================
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar participantes y asignaciones desde Firebase
            loadFromFirebase();
            
            // Mostrar la sección de login por defecto
            showSection('login-section');
        });

        // Función para actualizar estado de Firebase
        function updateFirebaseStatus(status, message) {
            const statusElement = document.getElementById('firebase-status');
            const adminStatusElement = document.getElementById('firebase-status-admin');
            
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `firebase-status ${status}`;
            }
            
            if (adminStatusElement) {
                adminStatusElement.textContent = message;
                adminStatusElement.className = `firebase-status ${status}`;
            }
        }

        // Función para cargar datos desde Firebase
        async function loadFromFirebase() {
            try {
                updateFirebaseStatus('disconnected', 'Firebase: Cargando datos...');
                
                // Cargar participantes
                const snapshot = await db.collection('participants').get();
                
                if (!snapshot.empty) {
                    allParticipants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateFirebaseStatus('connected', 'Firebase: Datos cargados correctamente');
                } else {
                    // Si no hay participantes, generar códigos y guardar
                    allParticipants = initialParticipants.map(p => ({ ...p }));
                    generateUniqueCodes();
                    await saveParticipantsToFirebase();
                }
                
                // Cargar asignaciones
                const assignSnapshot = await db.collection('assignments').get();
                assignments = {};
                
                if (!assignSnapshot.empty) {
                    assignSnapshot.docs.forEach(doc => {
                        assignments[doc.id] = doc.data().assignedTo;
                    });
                } else {
                    assignments = {};
                }
                
            } catch (error) {
                console.error("Error cargando desde Firebase:", error);
                updateFirebaseStatus('disconnected', 'Firebase: Error cargando datos. Usando modo local.');
                
                // Usar datos locales como fallback
                allParticipants = initialParticipants.map(p => ({ ...p }));
                generateUniqueCodes();
            }
        }

        // Función para guardar participantes en Firebase
        async function saveParticipantsToFirebase() {
            try {
                // Eliminar participantes existentes
                const snapshot = await db.collection('participants').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Agregar nuevos participantes
                const newBatch = db.batch();
                allParticipants.forEach(participant => {
                    const ref = db.collection('participants').doc();
                    newBatch.set(ref, {
                        name: participant.name,
                        gender: participant.gender,
                        code: participant.code
                    });
                });
                
                await newBatch.commit();
                showSuccess('Participantes guardados en Firebase correctamente');
                
            } catch (error) {
                console.error("Error guardando participantes:", error);
                showError("Error guardando en Firebase. Los datos se mantendrán localmente.");
            }
        }

        // Función para guardar asignaciones en Firebase
        async function saveAssignmentsToFirebase() {
            try {
                // Eliminar asignaciones existentes
                const snapshot = await db.collection('assignments').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Agregar nuevas asignaciones
                const newBatch = db.batch();
                for (const [name, assignedTo] of Object.entries(assignments)) {
                    const ref = db.collection('assignments').doc(name);
                    newBatch.set(ref, { assignedTo });
                }
                
                await newBatch.commit();
                showSuccess('Asignaciones guardadas en Firebase correctamente');
                
            } catch (error) {
                console.error("Error guardando asignaciones:", error);
                showError("Error guardando asignaciones en Firebase. Los datos se mantendrán localmente.");
            }
        }

        // =============================================
        // FUNCIONES DE LA APLICACIÓN
        // =============================================
        
        // Mostrar mensaje de error
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // Mostrar mensaje de éxito
        function showSuccess(message) {
            const successElement = document.getElementById('success-message');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }

        // Recargar lista de participantes y limpiar asignaciones
        async function reloadParticipants() {
            if (confirm('¿Estás seguro de que quieres recargar todos los participantes? Esto generará nuevos códigos y eliminará las asignaciones.')) {
                assignments = {};
                generateUniqueCodes();
                
                try {
                    await saveParticipantsToFirebase();
                    await clearAssignmentsInFirebase();
                    
                    showAdminPanel();
                    showSuccess('Lista de participantes recargada correctamente');
                    
                } catch (error) {
                    console.error("Error recargando participantes:", error);
                    showError("Error al recargar participantes. Verifica la conexión.");
                }
            }
        }

        // Limpiar asignaciones en Firebase
        async function clearAssignmentsInFirebase() {
            try {
                const snapshot = await db.collection('assignments').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
            } catch (error) {
                console.error("Error limpiando asignaciones:", error);
                throw error;
            }
        }

        // Generar códigos únicos para cada participante
        function generateUniqueCodes() {
            const codes = new Set();
            
            allParticipants.forEach(participant => {
                let code;
                do {
                    // Generar código alfanumérico de 6 caracteres
                    code = Math.random().toString(36).substring(2, 8).toUpperCase();
                } while (codes.has(code));
                
                codes.add(code);
                participant.code = code;
            });
        }

        // Mostrar sección específica
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar la sección solicitada
            document.getElementById(sectionId).classList.add('active');
        }

        // Verificar código y mostrar amigo secreto
        async function checkCode() {
            const codeInput = document.getElementById('code-input').value.trim();
            const participant = allParticipants.find(p => p.code === codeInput);
            
            if (participant) {
                if (assignments[participant.name]) {
                    // Mostrar amigo secreto ya asignado
                    showResult(assignments[participant.name]);
                } else {
                    // Asignar nuevo amigo secreto
                    await assignSecretFriend(participant, allParticipants);
                }
            } else {
                showError('Código inválido. Intenta nuevamente.');
            }
        }

        // Mostrar resultado
        function showResult(friendName) {
            // Mostrar resultado directo y claro
            const resultDiv = document.getElementById('friend-result');
            resultDiv.innerHTML = '';
            const msg = document.createElement('div');
            msg.textContent = `¡Tu amigo secreto es: ${friendName}!`;
            msg.style.marginTop = '18px';
            msg.style.fontSize = '22px';
            msg.style.fontWeight = 'bold';
            msg.style.color = '#1d3bb8';
            resultDiv.appendChild(msg);
            showSection('result-section');
            
            // Registrar evento en analytics
            analytics.logEvent('secret_friend_revealed', {
                friend_name: friendName
            });
        }

        // Asignar amigo secreto
        async function assignSecretFriend(participant, participants) {
            if (Object.keys(assignments).length === 0) {
                // Separar por género
                let mujeres = participants.filter(p => p.gender === 'mujer');
                let hombres = participants.filter(p => p.gender === 'hombre');
                
                // Mezclar aleatoriamente
                shuffleArray(mujeres);
                shuffleArray(hombres);
                
                // 1. Asignar a cada mujer un hombre diferente (12 mujeres -> 12 hombres)
                for (let i = 0; i < mujeres.length; i++) {
                    assignments[mujeres[i].name] = hombres[i].name;
                }
                
                // 2. Asignar a los primeros 12 hombres una mujer diferente
                // Mezclar nuevamente para aleatorizar
                shuffleArray(mujeres);
                for (let i = 0; i < mujeres.length; i++) {
                    assignments[hombres[i].name] = mujeres[i].name;
                }
                
                // 3. Los 2 hombres restantes se asignan entre sí
                assignments[hombres[12].name] = hombres[13].name;
                assignments[hombres[13].name] = hombres[12].name;
                
                // Guardar asignaciones en Firebase
                await saveAssignmentsToFirebase();
            }
            
            // Mostrar resultado para el participante actual
            if (assignments[participant.name]) {
                showResult(assignments[participant.name]);
            } else {
                showError('No hay asignación disponible para este participante.');
            }
        }

        // Función para mezclar un array (algoritmo Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Mostrar login de administrador
        function showAdminLogin() {
            showSection('admin-login-section');
        }

        // Verificar contraseña de administrador
        function checkAdminPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                showAdminPanel();
            } else {
                showError("Clave de administrador incorrecta");
            }
        }

        // Mostrar panel de administración
        async function showAdminPanel() {
            // Mostrar mensaje de carga
            document.getElementById('loading-message').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            document.querySelector('table').style.display = 'none';
            
            // Cargar datos más recientes desde Firebase
            await loadFromFirebase();
            
            const tableBody = document.getElementById('admin-table-body');
            tableBody.innerHTML = '';
            
            // Llenar la tabla con los participantes y sus códigos
            allParticipants.forEach(participant => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = participant.name;
                row.appendChild(nameCell);
                
                const codeCell = document.createElement('td');
                codeCell.textContent = participant.code;
                row.appendChild(codeCell);
                
                const assignmentCell = document.createElement('td');
                assignmentCell.textContent = assignments[participant.name] || 'No asignado';
                row.appendChild(assignmentCell);
                
                tableBody.appendChild(row);
            });
            
            // Ocultar mensaje de carga y mostrar tabla
            document.getElementById('loading-message').style.display = 'none';
            document.querySelector('table').style.display = 'table';
            
            showSection('admin-section');
        }

        // Eliminar todas las asignaciones
        async function clearAssignments() {
            if (confirm('¿Estás seguro de que quieres eliminar todas las asignaciones? Esto permitirá realizar nuevas asignaciones.')) {
                assignments = {};
                
                // Limpiar asignaciones en Firebase
                try {
                    await clearAssignmentsInFirebase();
                    showAdminPanel();
                    showSuccess('Asignaciones eliminadas correctamente.');
                    
                } catch (error) {
                    console.error("Error limpiando asignaciones:", error);
                    showError("Error al eliminar asignaciones. Verifica la conexión.");
                }
            }
        }

        // Exportar solo códigos a Excel
        function exportCodesExcel() {
            // Usar SheetJS para exportar a xlsx
            const data = allParticipants.map(p => ({ Nombre: p.name, Código: p.code }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Códigos");
            XLSX.writeFile(wb, "codigos_amigo_secreto.xlsx");
        }

        // Exportar nombre, código y asignado a Excel
        function exportFullExcel() {
            // Usar SheetJS para exportar a xlsx
            const data = allParticipants.map(p => ({
                Nombre: p.name,
                Código: p.code,
                Asignado: assignments[p.name] || ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Asignaciones");
            XLSX.writeFile(wb, "asignaciones_amigo_secreto.xlsx");
        }

        // Resetear la aplicación
        function resetApp() {
            document.getElementById('code-input').value = '';
            document.getElementById('admin-password').value = '';
            showSection('login-section');
        }
    </script>
</body>
</html>